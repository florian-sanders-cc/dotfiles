#!/usr/bin/env bash

# Smart focus script for Ghostty
# Cycles through existing Ghostty windows or spawns a new one if none exist

set -euo pipefail

# Function to get all window information from niri
get_windows() {
    niri msg --json windows
}

# Function to get currently focused window
get_focused_window() {
    get_windows | jq -r '.[] | select(.is_focused == true) | .id'
}

# Function to get all Ghostty windows
get_ghostty_windows() {
    get_windows | jq -r '.[] | select(.app_id == "com.mitchellh.ghostty") | .id'
}

# Function to focus window by ID
focus_window() {
    local window_id="$1"
    niri msg action focus-window --id="$window_id"
}

# Function to spawn new Ghostty instance
spawn_ghostty() {
    ghostty &
    disown
}

main() {
    local force_spawn="${1:-false}"
    
    if [[ "$force_spawn" == "true" ]]; then
        spawn_ghostty
        exit 0
    fi
    
    # Get all Ghostty windows
    local ghostty_windows
    ghostty_windows=$(get_ghostty_windows)
    
    # If no Ghostty windows exist, spawn one
    if [[ -z "$ghostty_windows" ]]; then
        spawn_ghostty
        exit 0
    fi
    
    # Convert to array
    readarray -t window_array <<< "$ghostty_windows"
    
    # Remove empty elements
    window_array=("${window_array[@]//}")
    
    # If only one window, focus it
    if [[ ${#window_array[@]} -eq 1 ]]; then
        focus_window "${window_array[0]}"
        exit 0
    fi
    
    # Multiple windows exist - cycle through them
    local current_focused
    current_focused=$(get_focused_window)
    
    # Find current Ghostty window in the array
    local current_index=-1
    for i in "${!window_array[@]}"; do
        if [[ "${window_array[$i]}" == "$current_focused" ]]; then
            current_index=$i
            break
        fi
    done
    
    # If current focused window is a Ghostty window, focus next one
    if [[ $current_index -ne -1 ]]; then
        local next_index=$(( (current_index + 1) % ${#window_array[@]} ))
        focus_window "${window_array[$next_index]}"
    else
        # Current focused window is not Ghostty, focus the first Ghostty window
        focus_window "${window_array[0]}"
    fi
}

main "$@"